using System.Collections;
using UnityEngine;

public class CarMovement : MonoBehaviour
{
    [Header("Wheel Colliders")]
    public WheelCollider FRCollider;
    public WheelCollider FLCollider;
    public WheelCollider RRCollider;
    public WheelCollider RLCollider;

    [Header("Wheel Meshes")]
    public Transform FLTire;
    public Transform FRTire;
    public Transform RLTire;
    public Transform RRTire;

    [Header("Car Settings")]
    public float MaxTorque = 300f; // Increased for more speed
    public float MaxTurn = 30f;
    public float BrakeForce = 3000f;

    [Header("Wheel Visual Offset")]
    public Vector3 WheelRotationOffset;

    [Header("Engine Sound")]
    public AudioSource EngineAudio;
    public float MinPitch = 0.8f;
    public float MaxPitch = 2f;
    public float MaxSpeedForPitch = 120f;

    [Header("Enter / Exit Car")]
    public Transform driverSeat;
    public Camera carCamera;
    public GameObject player;
    public Camera playerCamera;
    public PlayerMovement playerMovement;
    public float enterDistance = 3f;

    [Header("Stability Settings")]
    public float AntiRollForce = 5000f;
    public float DownForceValue = 100f;
    public float SpeedDownForceMultiplier = 2f;

    Rigidbody rb;
    bool isDriving = false;

    float accel;
    float steer;
    float brake;

    Vector3 wheelPos;
    Quaternion wheelRot;

    // ---------------- INIT ----------------
    void Awake()
    {
        rb = GetComponent<Rigidbody>();

        // Adjust rigidbody for better stability
        rb.centerOfMass = new Vector3(0, -0.5f, 0); // Lower center of mass
        rb.interpolation = RigidbodyInterpolation.Interpolate; // Smooth movement
        rb.collisionDetectionMode = CollisionDetectionMode.Continuous; // Changed from ContinuousDynamic

        // Configure wheel colliders for stability
        ConfigureWheelCollider(FLCollider);
        ConfigureWheelCollider(FRCollider);
        ConfigureWheelCollider(RLCollider);
        ConfigureWheelCollider(RRCollider);

        if (EngineAudio != null)
            EngineAudio.Play();
    }

    void ConfigureWheelCollider(WheelCollider col)
    {
        // Increase spring and damper for stability
        WheelFrictionCurve forward = col.forwardFriction;
        forward.stiffness = 2f; // Reduced stiffness to prevent wiggling
        col.forwardFriction = forward;

        WheelFrictionCurve sideways = col.sidewaysFriction;
        sideways.stiffness = 2f; // Reduced stiffness
        col.sidewaysFriction = sideways;

        // Stiffer suspension
        JointSpring spring = col.suspensionSpring;
        spring.spring = 35000f;
        spring.damper = 4500f;
        col.suspensionSpring = spring;

        col.suspensionDistance = 0.3f;
        col.forceAppPointDistance = 0f;
    }

    // ---------------- UPDATE ----------------
    void Update()
    {
        UpdateWheel(FLCollider, FLTire);
        UpdateWheel(FRCollider, FRTire);
        UpdateWheel(RLCollider, RLTire);
        UpdateWheel(RRCollider, RRTire);

        if (Input.GetKeyDown(KeyCode.J))
        {
            if (isDriving)
                ExitCar();
            else
                TryEnterCar();
        }
    }

    // ---------------- PHYSICS ----------------
    void FixedUpdate()
    {
        if (!isDriving)
        {
            // Apply brakes when not driving to prevent rolling
            ApplyBrakes(BrakeForce);
            return;
        }

        accel = Input.GetAxis("Vertical");
        steer = Input.GetAxis("Horizontal");
        brake = Input.GetKey(KeyCode.Space) ? 1f : 0f;

        RLCollider.motorTorque = accel * MaxTorque;
        RRCollider.motorTorque = accel * MaxTorque;

        FLCollider.steerAngle = steer * MaxTurn;
        FRCollider.steerAngle = steer * MaxTurn;

        ApplyBrakes(brake * BrakeForce);

        // Add downforce for high-speed stability
        ApplyDownforce();

        // Add anti-roll bars to prevent flipping
        ApplyAntiRoll(FLCollider, FRCollider);
        ApplyAntiRoll(RLCollider, RRCollider);

        UpdateEngineSound();
    }

    // ---------------- STABILITY HELPERS ----------------
    void ApplyDownforce()
    {
        float speed = rb.linearVelocity.magnitude;
        float downforce = DownForceValue + (speed * SpeedDownForceMultiplier);
        rb.AddForce(-transform.up * downforce);
    }

    void ApplyAntiRoll(WheelCollider leftWheel, WheelCollider rightWheel)
    {
        WheelHit hit;
        float travelL = 1.0f;
        float travelR = 1.0f;

        bool groundedL = leftWheel.GetGroundHit(out hit);
        if (groundedL)
            travelL = (-leftWheel.transform.InverseTransformPoint(hit.point).y - leftWheel.radius) / leftWheel.suspensionDistance;

        bool groundedR = rightWheel.GetGroundHit(out hit);
        if (groundedR)
            travelR = (-rightWheel.transform.InverseTransformPoint(hit.point).y - rightWheel.radius) / rightWheel.suspensionDistance;

        float antiRollForce = (travelL - travelR) * AntiRollForce;

        if (groundedL)
            rb.AddForceAtPosition(leftWheel.transform.up * -antiRollForce, leftWheel.transform.position);
        if (groundedR)
            rb.AddForceAtPosition(rightWheel.transform.up * antiRollForce, rightWheel.transform.position);
    }

    // ---------------- ENTER CAR ----------------
    void TryEnterCar()
    {
        if (Vector3.Distance(player.transform.position, transform.position) > enterDistance)
            return;

        isDriving = true;

        CharacterController cc = player.GetComponent<CharacterController>();
        if (cc != null)
        {
            cc.enabled = false;
        }
        
        if (playerMovement != null)
        {
            playerMovement.canMove = false;
        }

        player.transform.SetParent(transform);
        player.transform.position = driverSeat.position;
        player.transform.rotation = driverSeat.rotation;

        if (playerCamera != null)
            playerCamera.enabled = false;
        if (carCamera != null)
            carCamera.enabled = true;
    }

    // ---------------- EXIT CAR ----------------
    void ExitCar()
    {
        isDriving = false;

        // Stop all motor torque
        RLCollider.motorTorque = 0;
        RRCollider.motorTorque = 0;

        // Apply brakes to stop the car
        ApplyBrakes(BrakeForce);

        // Freeze the car's rigidbody temporarily to prevent launching
        rb.linearVelocity = Vector3.zero;
        rb.angularVelocity = Vector3.zero;

        // Unparent player first
        player.transform.SetParent(null);

        // Calculate exit position with better ground detection
        Vector3 exitPos = transform.position + transform.right * 3f;
        exitPos.y += 2f; // Start higher for raycast

        // Find ground below exit position
        if (Physics.Raycast(exitPos, Vector3.down, out RaycastHit hit, 20f, ~0, QueryTriggerInteraction.Ignore))
        {
            exitPos = hit.point + Vector3.up * 1f; // Place 1 unit above ground
        }
        else
        {
            // Fallback if no ground found
            exitPos = transform.position + transform.right * 3f + Vector3.up * 1f;
        }

        player.transform.position = exitPos;
        player.transform.rotation = Quaternion.Euler(0, transform.eulerAngles.y, 0);

        // Re-enable character controller after positioning
        CharacterController cc = player.GetComponent<CharacterController>();
        if (cc != null)
        {
            StartCoroutine(EnableControllerNextFrame(cc));
        }

        if (playerMovement != null)
        {
            playerMovement.canMove = true;
        }

        if (carCamera != null)
            carCamera.enabled = false;
        if (playerCamera != null)
            playerCamera.enabled = true;
    }

    IEnumerator EnableControllerNextFrame(CharacterController cc)
    {
        yield return new WaitForFixedUpdate();
        yield return null;
        cc.enabled = true;
    }

    // ---------------- HELPERS ----------------
    void ApplyBrakes(float force)
    {
        FLCollider.brakeTorque = force;
        FRCollider.brakeTorque = force;
        RLCollider.brakeTorque = force;
        RRCollider.brakeTorque = force;
    }

    void UpdateWheel(WheelCollider col, Transform wheel)
    {
        col.GetWorldPose(out wheelPos, out wheelRot);
        wheel.position = wheelPos;
        wheel.rotation = wheelRot * Quaternion.Euler(WheelRotationOffset);
    }

    void UpdateEngineSound()
    {
        if (EngineAudio == null) return;

        float speed = rb.linearVelocity.magnitude * 3.6f;
        float t = Mathf.Clamp01(speed / MaxSpeedForPitch);
        EngineAudio.pitch = Mathf.Lerp(MinPitch, MaxPitch, t);
    }
}
